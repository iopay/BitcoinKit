//
//  MultiSigTests.swift
//  
//
//  Created by liugang zhang on 2024/5/9.
//

import XCTest
@testable import BitcoinKit

final class MultiSigTests: XCTestCase {

    func testMultiSig2of4() throws {
        let keys = [
            "da74ae306a968f377e1b51460c253031f043b4f359dc5bfda3b1ae785173c9c4",
            "25738c1e747039d32889300b91b17038e8bd2b14224ff507f35887edc8f56c2e",
            "c5128c891577c71735cb4f95c88e5c557e20a5ca85ab269dc4949d5f2e17836f",
            "f7636a24b45809967049232963f4b8689c356fee2e5aa6df9a33d2f13d150b98"
        ].map { PrivateKey(data: Data(hex: $0)) }

        let psbt = try Psbt.deserialize("70736274ff0100550200000001ecfb41d7842ba9cbf16c80b1fba9930f6da0726623c0e1f5e3aec9e236839e5b0000000000ffffffff0110270000000000001976a914f4c6c5bb10ea6370a13b96cc08870628b76ad06e88ac00000000000100be0200000001b56260312db89d35878da2c9c65105b101b93b14c57c3105c2ea3cc516093fc7010000006b483045022100d5ee984dedc90f7f7ff1d0feb4964ee86f640d987929ff59d04ad63f106d1c74022005582bc3ade636536fc955b16a702d2ef467d6a27e82ab69616205b1c58883b20121028154c8e5566685a645cd992fb2f39c310b810ad0312427b56c1778ad7c6bdcc9ffffffff01204e00000000000017a914464ce725630f2002e79163552a24eabc2749bbb4870000000001048b5221025be3bf4b6fe0e1ad2d754b9a65bb3a22fcbf914dccbbe38d812604e7d34f06fb21030292a53b595066c420ddb082d9be4095c2bf9db8107ccc0f8049d14c86cf44b72103179961604ae4663eab2998d9a48c11e7e5866a4e43c98f1489f8ecffd163e0b12103a8c07929ef23231e8b3e5cc7ad3031524e2f7cb04fd0a66bc2b45e3a3244629554ae0000")
        try psbt.signInput(with: keys[0], at: 0)
        try psbt.signInput(with: keys[2], at: 0)
        try psbt.finalizeAllInputs()
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "0200000001ecfb41d7842ba9cbf16c80b1fba9930f6da0726623c0e1f5e3aec9e236839e5b00000000fd1f0100483045022100f171f3b040f1c5a581647a4a73d621128d4c41cea6f80ca7e196490dd14bd524022027f2237aa5463db23a94b7d98ff2ba1568f50f828bf237cfba03f1962e02492401473044022044ea0450a0beb54c46c5521646620fb9b22f7ac7b59d9061256a1081c224788002206369a6c56ec989082f6d3388d5c7c1abdc76db65a9ebca467f4c48e84036e447014c8b5221025be3bf4b6fe0e1ad2d754b9a65bb3a22fcbf914dccbbe38d812604e7d34f06fb21030292a53b595066c420ddb082d9be4095c2bf9db8107ccc0f8049d14c86cf44b72103179961604ae4663eab2998d9a48c11e7e5866a4e43c98f1489f8ecffd163e0b12103a8c07929ef23231e8b3e5cc7ad3031524e2f7cb04fd0a66bc2b45e3a3244629554aeffffffff0110270000000000001976a914f4c6c5bb10ea6370a13b96cc08870628b76ad06e88ac00000000")
    }

    func test_p2wsh() throws {
        let key = PrivateKey(data: Data(hex: "5ec07a7794576b9965ff14489cb4f3f434e115c3f065be3e2f16a6ceeb07fed5"))
        let psbt = try Psbt.deserialize("70736274ff0100550200000001638636f2c86278cfa35a29417b116c104c069ca2fd660b5c97e24de197bee7a10000000000ffffffff01204e0000000000001976a914ca37c3254c756381b99017250cb07780c42ea0d988ac00000000000100bd0200000001839f7111b208926680fdbe6d0184bafa2bf77f3ad9583386d6938fd48d8eabb1000000006b483045022100bc37b7dbc7e3fc02a75903bacec493fe69026b9dfb8b31398e1ae25976856ed102207c2d9a387bd74d4bf6f6cee233372373e4c387babd85e3f346c93439194272a5012103875d418c435ebe27778b4fed26ebc2a12cace77fdbdad2cb7289a0c78e0d1e39ffffffff0150c3000000000000160014b64da5f41270fb080835f32571620a9ecd2cdbe000000000220202196a9977e7566df235cf1d87feec372795830eeb7c12b6071c263c89e4ae43b9473044022007bb61183cf3330c77bb1bbaaf9552ee7081ff79ef6528bd7b4705d3e2f9ca2802207fa8a7ecbff2fb3e43aea0a11d2fc92ea178673402403019288d7cccfd852801010000")
        try psbt.signAllInputs(with: key)
        try psbt.finalizeAllInputs()
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "02000000000101638636f2c86278cfa35a29417b116c104c069ca2fd660b5c97e24de197bee7a10000000000ffffffff01204e0000000000001976a914ca37c3254c756381b99017250cb07780c42ea0d988ac02473044022007bb61183cf3330c77bb1bbaaf9552ee7081ff79ef6528bd7b4705d3e2f9ca2802207fa8a7ecbff2fb3e43aea0a11d2fc92ea178673402403019288d7cccfd852801012102196a9977e7566df235cf1d87feec372795830eeb7c12b6071c263c89e4ae43b900000000")
    }

    func test_p2wsh_p2pk() throws {
        let key = PrivateKey(data: Data(hex: "5bf3cc73686f1435e290cec777c31cc07ec466a6ba81c41694e07d1257e303b0"))
        let psbt = try Psbt.deserialize("70736274ff0100550200000001ae48d3f2064206474e6f1c742474cd9f8dbae1ebea491872ae2e560f35c109580000000000ffffffff01204e0000000000001976a914e1ac2e226c00702250ce68421728581a784629f288ac000000000001012b50c30000000000002200208e3b598b28c4fc0eb929ed20ea9cabf713bc2f42d9a1c748195b17a5604c764c0105232103258c10e87daa69f45da6a2f440a76b9cc930967ad2f217ea51bbc302f1d4fc23ac0000")
        try psbt.signAllInputs(with: key)
        try psbt.finalizeAllInputs()
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "02000000000101ae48d3f2064206474e6f1c742474cd9f8dbae1ebea491872ae2e560f35c109580000000000ffffffff01204e0000000000001976a914e1ac2e226c00702250ce68421728581a784629f288ac02483045022100c674557dcaff3602456f426dc0bd5f665622c2715950768ae5aff3b37a4b357d02202e2c506d576247a4f1cf1f08538903c256f0372dc7e61e3a091e971db71b008901232103258c10e87daa69f45da6a2f440a76b9cc930967ad2f217ea51bbc302f1d4fc23ac00000000")
    }

    func test_p2sh_p2wsh_p2ms_3of4() throws {
        let keys = [
            "6c133520eaa39a282272c80770d505d20d32044836c73dc7123deb5b2409c2c4",
            "e6ff7d56b7aa698fac879f42f6e1c965160a681ea3986a8bc19d64a1122789ad",
            "adc62a6a87569e46d2466236567c34d0362d9affc7d4d6d1f3bd83f102697733",
            "2a475660404144127f1ef52b3bc908649fb4fed416ae8eb942bec0a167ccf64d"
        ].map { PrivateKey(data: Data(hex: $0)) }

        let psbt = try Psbt.deserialize("70736274ff0100550200000001b40c81d26b3dfe4e3d7a58af523b3d60f90440e82f83215d9c6d3adc1744194e0000000000ffffffff01204e0000000000001976a914024d138f7bad1e29968c77494c8c9d81266b500c88ac000000000001012050c300000000000017a914b9881e2ae548e9df6d4cb51ae829e92ee69f374f87010422002051710a28cd530519031d43e209ff2c88a3ef3b6e74463973781c7105a6d52bfa01058b532102009a970aa5d49c9b2841fcf7e1c4e3e016d7c3f2f75751a324e1cc4f1596984921025247e84679ff04eb650ad62ea430388ce7b1334e63b6476bf9a750c46abd56b621026b00fda27e3e630fcef3d694ab1f1b525d23cd954d62746dfaf40a0a1b74b97a210328753c84425184f2d7ab5d870dc8f34182526ae6b3a73bc12d84f8791264216654ae0000")
        try psbt.signInput(with: keys[0], at: 0)
        try psbt.signInput(with: keys[2], at: 0)
        try psbt.signInput(with: keys[3], at: 0)
        try psbt.finalizeAllInputs()
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "02000000000101b40c81d26b3dfe4e3d7a58af523b3d60f90440e82f83215d9c6d3adc1744194e000000002322002051710a28cd530519031d43e209ff2c88a3ef3b6e74463973781c7105a6d52bfaffffffff01204e0000000000001976a914024d138f7bad1e29968c77494c8c9d81266b500c88ac0500473044022003fe8bbd18cefe800a6906096d3901580d1bdf6734b406899a396c33ea756bf402204e7a6193b50b48b78a0977a239a11a225c8cce9fcec2f708cbd3ef88048e036d0148304502210085912481dd8e28ab2ce09f809bc54130af9d6d004fec553b8ba6d1006a64fb1b022060c2da850b00de63ddae5f86d88a6020123f0ea4b2c65c3d2d22aa4cc4abfc2f01483045022100d78f283b99cf450ad4993f05a468f22ff15e2f5713fc99687c0272b05ee1a0e802204794ab0ea6ad94d9426d02e3d25c5048d1e9665cfa81379da0a8838bc1309eb2018b532102009a970aa5d49c9b2841fcf7e1c4e3e016d7c3f2f75751a324e1cc4f1596984921025247e84679ff04eb650ad62ea430388ce7b1334e63b6476bf9a750c46abd56b621026b00fda27e3e630fcef3d694ab1f1b525d23cd954d62746dfaf40a0a1b74b97a210328753c84425184f2d7ab5d870dc8f34182526ae6b3a73bc12d84f8791264216654ae00000000")
    }

    func test_p2sh_p2wsh_p2ms_3of4_nonWitnessUtxo() throws {
        let keys = [
            "da703d0d9ccd4ca906f37df272e61edb43f69946ba4c5e823083183ea2583203",
            "9a04be5175bef803997b4810d200392530e77855a9008c81ee0a0dd4622e6c51",
            "4c1e3afba6c486e09d7674c18ffb55ae3573db684d556de9d375d0734694dbe7",
            "eb1d0565e90a4c96734f61adfb35a3d6f44a38eeffb6ed12f443a3fe085b27f6"
        ].map { PrivateKey(data: Data(hex: $0)) }

        let psbt = try Psbt.deserialize("70736274ff010055020000000167644caec8b0e5749940fd08507b8a71707b8b34e8c385e378a5b6ca8a8dbdac0000000000ffffffff01204e0000000000001976a91456effda2426525fc76136b181e5c87542bc17e6b88ac00000000000100be020000000125883da8518b86a6f85b2d9d58db0eac874fa50c12d83fa7ced1a95045b7f06a000000006b483045022100dfd2cad8d188e4b2cd9999b4cae4b724376fdf31ee2b9e85473423c0b9ca6c4402202eb10246114493921e068334f7e939cf38c42f4a71b3232e69ce609ab12c959d0121037acfc9b97dc4734821d8b62483e1df9f32d7df127c1bb1bd80babcb88d21ea1fffffffff0150c300000000000017a9144e14a5c00368fb6d8bd5426c9dac5d25dc8590a48700000000010422002081352bd898e4fe619ffe0ba7ae9bbf6264be97500b01778704d04a3b7bf1d5e001058b53210330e99bf986d9da2269504d00213d6cfb90fde8c96c8a1ae4e4bfdbba12ef387221035885e8cd1d2060fb9a96ab930241c8e1275da1640abc09c7583269d79af9f9b92103988a6049c0b6a1c31df0e19fe80646c71ea92ee2b3d90cdf628ddc6884e816962103c5558e0f25cc5cf272719375b268b4b0a00d2be4a93928a0f4a3f9675c7985d054ae0000")
        try psbt.signInput(with: keys[0], at: 0)
        try psbt.signInput(with: keys[2], at: 0)
        try psbt.signInput(with: keys[3], at: 0)
        try psbt.finalizeAllInputs()
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "0200000000010167644caec8b0e5749940fd08507b8a71707b8b34e8c385e378a5b6ca8a8dbdac000000002322002081352bd898e4fe619ffe0ba7ae9bbf6264be97500b01778704d04a3b7bf1d5e0ffffffff01204e0000000000001976a91456effda2426525fc76136b181e5c87542bc17e6b88ac050047304402203b943770d9823f4417f5ae421223c2d0a304b54ebac8b5cee5206ca0698ff1ae022029fbe16a5c68085696fbf6978c3008f171230f74c38b59c69ab15257f0c3fbd401483045022100b08d0da25184c12b5c31f157152c3d7732d4285ef5fbb1ba6512f67ddcbe017002204fc95ca2ada48295145ac0b5136383459f5b4c7d0f0367233af448b865b49235014830450221008b1ce0b49918993ebd5bb6aaf7d393131b8609c6575b2c2830d763680cf0fb590220220e3fa79fcceacc9d6899e7b802612190875ac93b0c0a6414b9022ec1ce69aa018b53210330e99bf986d9da2269504d00213d6cfb90fde8c96c8a1ae4e4bfdbba12ef387221035885e8cd1d2060fb9a96ab930241c8e1275da1640abc09c7583269d79af9f9b92103988a6049c0b6a1c31df0e19fe80646c71ea92ee2b3d90cdf628ddc6884e816962103c5558e0f25cc5cf272719375b268b4b0a00d2be4a93928a0f4a3f9675c7985d054ae00000000")
    }

    func test_p2sh_p2ms_2of2_nonWitnessUtxo() throws {
        let keys = [
            "e02c0c3fd01eae5f5a8571be02a16a2004afd52f8ec632bfee019057f73cf4ac",
        ].map { PrivateKey(data: Data(hex: $0)) }

        let psbt = try Psbt.deserialize("70736274ff0100550200000001989fe39867277eb4a78f60fab5b56135ba5c12fc98e006df2b06e83a111ce96a0000000000ffffffff01204e0000000000001976a9144c33ff18f64851844782a1b1e4ae8904ff12086c88ac00000000000100be0200000001db35d8aa985665c1378ca6ea7a0bbacb6bedbb3a5c72a77876694a5995a761e7010000006b483045022100e1c418892054966260635de8e8756eb653e495653455a31c042743962eb304ff02203808e988662277e9338ad237b05128f8b4542f15713a5d6ef324358dc8d017490121028aaf7a6256b80a2d868bed0b8a36b9e5d00861e301c3d404b5fb73d2c5e54725ffffffff0150c300000000000017a91488f6b54fabc6de35b13f0e0bbf2b6bb354876e9e87000000000104475221026d939ac9eaca0a7cff96711dfbbc3f0c498a917229fa568bca18b9c1d85d7f3221026d939ac9eaca0a7cff96711dfbbc3f0c498a917229fa568bca18b9c1d85d7f3252ae0000")
        try psbt.signInput(with: keys[0], at: 0)
        try psbt.finalizeAllInputs()
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "0200000001989fe39867277eb4a78f60fab5b56135ba5c12fc98e006df2b06e83a111ce96a00000000d90047304402206b031a9f62d32934520f9d217be7e1a324244999ad714e42645d52ba2d360bfb02207368352890bbebe3179f77d8d3385200b8d529beac2286c0fd1a71bf38d4ffda0147304402206b031a9f62d32934520f9d217be7e1a324244999ad714e42645d52ba2d360bfb02207368352890bbebe3179f77d8d3385200b8d529beac2286c0fd1a71bf38d4ffda01475221026d939ac9eaca0a7cff96711dfbbc3f0c498a917229fa568bca18b9c1d85d7f3221026d939ac9eaca0a7cff96711dfbbc3f0c498a917229fa568bca18b9c1d85d7f3252aeffffffff01204e0000000000001976a9144c33ff18f64851844782a1b1e4ae8904ff12086c88ac00000000")
    }
}
