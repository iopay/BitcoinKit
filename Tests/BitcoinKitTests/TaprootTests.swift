//
//  TaprootTests.swift
//  
//
//  Created by liugang zhang on 2024/5/9.
//

import XCTest
@testable import BitcoinKit

class TaprootTests: XCTestCase {
    func testTaprootKeypath() throws {
        let pk0 = PrivateKey(data: Data(hex: "8dc789be1980af50d795c2a0dd2d12146d566331647f06c2071132b769386468"))
        let pk1 = PrivateKey(data: Data(hex: "4b411ea54a715c78e01eed8e3fca3345ee1328fb09e4d7d077b0f814bbaf1779"))

        print(pk0.toWIF())
        print(pk1.toWIF())

        let psbt = try Psbt.deserialize("70736274ff0100870200000002df7bba486867a96b4b2b029cc75d7594acb8b8b1c1f434e7cd63919b07c7721e0000000000ffffffffefbaef221bf1d5531f4ccd6cdf7c4f66cc7fa9e0743b674c7103f3aa914772810000000000ffffffff019041060000000000225120a3205ba404248e358829ba837b9585d137bc9bdd415b482fa3864f0d33936597000000000001012ba068060000000000225120d8f0d2a91beac3004bd6c02aaf9b86ac2e6b02e31e4c96b7f1248de5b582854401172062fe5466a62c8f401dc77d22daabcaa920598f8a74ed2405f03c7cd57dae001b000100bf0200000001f3693486ed31f55bc9fb429193df9355e3decc99e2a7c4eed295dd46d7b544fe010000006a473044022068fc69dab0a492474dbe00e0f4d7f79e839960902bf2304173eee09d7c822d3202202f45f589fff90c0b547d54c477fcd1bdb2fc5f5b82201db256fcb9a3a0fe2a540121027150b85099c24925c0b677fe1175817b8de40c0925f4d5cb746ca3331b30d2feffffffff01a0680600000000001976a9146ba0e1df98b4ba6ee77cf9317ff980ec4d3639e588ac000000000001052064b3e361fd97b5564eda2993dd271265fd1eaa5ffe0c5c3b072fb9782a889a7000")
        XCTAssertEqual(psbt.tx.inputs[0].previousOutput.hash.hex, "df7bba486867a96b4b2b029cc75d7594acb8b8b1c1f434e7cd63919b07c7721e")
        XCTAssertEqual(psbt.inputs[0].witnessUtxo?.lockingScript.hex, "5120d8f0d2a91beac3004bd6c02aaf9b86ac2e6b02e31e4c96b7f1248de5b5828544")
        XCTAssertEqual(psbt.inputs[0].witnessUtxo?.value, 420000)
        XCTAssertEqual(psbt.inputs[0].tapInternalKey?.hex, "62fe5466a62c8f401dc77d22daabcaa920598f8a74ed2405f03c7cd57dae001b")
        XCTAssertEqual(psbt.tx.inputs[1].previousOutput.hash.hex, "efbaef221bf1d5531f4ccd6cdf7c4f66cc7fa9e0743b674c7103f3aa91477281")
        XCTAssertEqual(psbt.tx.outputs[0].value, 410000)
        XCTAssertEqual(psbt.tx.outputs[0].lockingScript.hex, "5120a3205ba404248e358829ba837b9585d137bc9bdd415b482fa3864f0d33936597")
        XCTAssertEqual(psbt.outputs[0].tapInternalKey?.hex, "64b3e361fd97b5564eda2993dd271265fd1eaa5ffe0c5c3b072fb9782a889a70")

        try psbt.signInput(with: pk0.tweaked, at: 0)
        try psbt.signInput(with: pk1, at: 1)

        XCTAssertEqual(psbt.inputs[0].tapKeySig?.hex, "7f57dbcd71fcf8d1aa8e82f16d2096b9e90b86789f53931b82d3258d34f342d566fe06ee545a2bca690d7cd215c8cf4fa49ef878052e73f763eac4b98aa5d3a5")
        XCTAssertEqual(psbt.inputs[1].partialSig?.count, 1)
        XCTAssertEqual(psbt.inputs[1].partialSig?.first?.pubkey.hex, "0261f2ba743ba648041ca2bfaed36eedd86e7216104204d75ac8595241c81590c7")
        XCTAssertEqual(psbt.inputs[1].partialSig?.first?.signature.hex, "3044022024312bb863065f11df385deea3e099b68ed328bc480c6afc9c89da506ee06e4d02204aa421018fc578847c63079e8596f58091b17ac1550c28af42d6b8d51016bc2201")

        try psbt.finalizeAllInputs()

        XCTAssertEqual(psbt.serialized().hex, "70736274ff0100870200000002df7bba486867a96b4b2b029cc75d7594acb8b8b1c1f434e7cd63919b07c7721e0000000000ffffffffefbaef221bf1d5531f4ccd6cdf7c4f66cc7fa9e0743b674c7103f3aa914772810000000000ffffffff019041060000000000225120a3205ba404248e358829ba837b9585d137bc9bdd415b482fa3864f0d33936597000000000001012ba068060000000000225120d8f0d2a91beac3004bd6c02aaf9b86ac2e6b02e31e4c96b7f1248de5b582854401084201407f57dbcd71fcf8d1aa8e82f16d2096b9e90b86789f53931b82d3258d34f342d566fe06ee545a2bca690d7cd215c8cf4fa49ef878052e73f763eac4b98aa5d3a5000100bf0200000001f3693486ed31f55bc9fb429193df9355e3decc99e2a7c4eed295dd46d7b544fe010000006a473044022068fc69dab0a492474dbe00e0f4d7f79e839960902bf2304173eee09d7c822d3202202f45f589fff90c0b547d54c477fcd1bdb2fc5f5b82201db256fcb9a3a0fe2a540121027150b85099c24925c0b677fe1175817b8de40c0925f4d5cb746ca3331b30d2feffffffff01a0680600000000001976a9146ba0e1df98b4ba6ee77cf9317ff980ec4d3639e588ac0000000001076a473044022024312bb863065f11df385deea3e099b68ed328bc480c6afc9c89da506ee06e4d02204aa421018fc578847c63079e8596f58091b17ac1550c28af42d6b8d51016bc2201210261f2ba743ba648041ca2bfaed36eedd86e7216104204d75ac8595241c81590c70001052064b3e361fd97b5564eda2993dd271265fd1eaa5ffe0c5c3b072fb9782a889a7000")
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "02000000000102df7bba486867a96b4b2b029cc75d7594acb8b8b1c1f434e7cd63919b07c7721e0000000000ffffffffefbaef221bf1d5531f4ccd6cdf7c4f66cc7fa9e0743b674c7103f3aa91477281000000006a473044022024312bb863065f11df385deea3e099b68ed328bc480c6afc9c89da506ee06e4d02204aa421018fc578847c63079e8596f58091b17ac1550c28af42d6b8d51016bc2201210261f2ba743ba648041ca2bfaed36eedd86e7216104204d75ac8595241c81590c7ffffffff019041060000000000225120a3205ba404248e358829ba837b9585d137bc9bdd415b482fa3864f0d3393659701407f57dbcd71fcf8d1aa8e82f16d2096b9e90b86789f53931b82d3258d34f342d566fe06ee545a2bca690d7cd215c8cf4fa49ef878052e73f763eac4b98aa5d3a50000000000")
    }

    func test_taproot_key_path_unused_scriptTree() throws {
        let key = PrivateKey(data: Data(hex: "e286f829409032aae602159aaaa533841c178cc35b8cf087974f14a53366d004"))
        let psbt = try Psbt.deserialize("70736274ff01005e0200000001cc3f152a5e95a490598e4a57bf22c96933d3f131acc7caea8f8ee45de98da3a20000000000ffffffff019041060000000000225120ab3df01dbd34584e676b78e9c89876b6058de5ec198b0c99b0270e143fc7876e000000000001012ba068060000000000225120ab3df01dbd34584e676b78e9c89876b6058de5ec198b0c99b0270e143fc7876e011720e3d404717bcd86632e48e2ddc7530416b7e5b100d3730e5b23ac46ba5bbafc1a011820a1f79ea1d05ce9b7f0a298a4845159f2ca980146d8b0839f55e2dc59bbdbc23e0000")
        try psbt.signInput(with: key, at: 0)
        try psbt.finalizeAllInputs()
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "02000000000101cc3f152a5e95a490598e4a57bf22c96933d3f131acc7caea8f8ee45de98da3a20000000000ffffffff019041060000000000225120ab3df01dbd34584e676b78e9c89876b6058de5ec198b0c99b0270e143fc7876e0140195f99637612aed303160aab978c633b8eeb5cab98fd8f6fa48117d665364b3e54a7a19df16c76f1d5ee3498a5c1c699e67b3c01b43f8d39aa8f50550ae6325e00000000")
    }

    func test_taproot_script_path_OP_CHECKSIG() throws {
        let key = PrivateKey(data: Data(hex: "e17ec9388430634560985a82d5139168e15b24b38ae106f30fcfd940980ccb13"))
        let psbt = try Psbt.deserialize("70736274ff01005e02000000018ddf372c20015b671eee2f32b8cd768213f4196ff726d9fe50e9053425d1f9d70000000000ffffffff0190410600000000002251203a24dff8357017c6e925763cc0f5bf39575d77933622057f222a52ae505e6a5b000000000001012ba068060000000000225120445460d7f774f88f95b52f3640798444ef3182b6d620106555734cdb9841e537a215c14f376c2590f21d8c0b2cc2d4d9d8033ccfe1880b68978a0fd91509a3615794d6b424dea09f840b932a00373cdcdbd25650b8c3acfe54a9f4a641a286721b8d26dac795766bbda1eaeaa45e5bfa0a950fdd5f4c4aada5b1f3082edc9689b9fd0aee28a3b82c4aecbebd378127dc88dd19e1ea93edba7a27b754e1c881d308874a7ac4489544b7b840d045599ec9415ae71ccb090c2c465c05c9fa05f41c7a06d523200d834a0edc56cb2614ea4e9a5b86f139a89098b84874edbe31dbefb761443ee5acc0000105204a4d52c972102ca39f68d48d253b891c1214dcda319e6d9a64ed30b15af3def50106fd030102c0222050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0ac03c0222050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac1ac03c022202258b1c3160be0864a541854eec9164a572f094f7562628281a8073bb89173a7ac02c0222050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac2ac03c0222050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac3ac04c0222050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac4ac04c022200d834a0edc56cb2614ea4e9a5b86f139a89098b84874edbe31dbefb761443ee5ac00")
        try psbt.signInput(with: key, at: 0)
        try psbt.finalizeAllInputs()
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "020000000001018ddf372c20015b671eee2f32b8cd768213f4196ff726d9fe50e9053425d1f9d70000000000ffffffff0190410600000000002251203a24dff8357017c6e925763cc0f5bf39575d77933622057f222a52ae505e6a5b0340a37e365698eee3a77189273b8e529afec595395a33ede3afdf6c99ae4c4d3cc7652d53e95f0b888b60b37b973bd43436ee10aa1ce5a1d7b10055f3d6c0594fbb22200d834a0edc56cb2614ea4e9a5b86f139a89098b84874edbe31dbefb761443ee5aca1c14f376c2590f21d8c0b2cc2d4d9d8033ccfe1880b68978a0fd91509a3615794d6b424dea09f840b932a00373cdcdbd25650b8c3acfe54a9f4a641a286721b8d26dac795766bbda1eaeaa45e5bfa0a950fdd5f4c4aada5b1f3082edc9689b9fd0aee28a3b82c4aecbebd378127dc88dd19e1ea93edba7a27b754e1c881d308874a7ac4489544b7b840d045599ec9415ae71ccb090c2c465c05c9fa05f41c7a06d500000000")
    }

    func test_taproot_script_path_OP_CHECKSEQUENCEVERIFY() throws {
        let key = PrivateKey(data: Data(hex: "064c95364bcb8f9e9da69133d522eceb62ff4b128f24c72e7319900f95353523"))
        let psbt = try Psbt.deserialize("70736274ff01005e0200000001bb49a80aabf0c7a8176eb7f573e19d727f305ef5f16ecb5997deac876d30c69300000000000a000000019041060000000000225120c462d8481f603feafee8298b9611fdb3a66d783e301eee33b6a75423ef6a9f85000000000001012ba06806000000000022512034c2bf9b9449047b50fb4d7746e33d01fbb533d55380ba53e862cdfe0847a4536215c14008cb657acd7c2492a41c7b12ea5394e92ed8675ad0988079afa5b03fa314881a529c9fb3cd7e776d61b6225b6c610e8906fb8faa6c59ac5c3e95b5f82d29d61a529c9fb3cd7e776d61b6225b6c610e8906fb8faa6c59ac5c3e95b5f82d29d6265ab27520cfd7ef4b9c09cfe95a1ffa7e0b1d1ed8e22f2b2424d04f5009539de2a08d0471acc000010520673337487f71ca251ebbe352f6756b1fde557e839c27bcfa9ff300f5bbd0d5a601067201c0222050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0ac02c0222050929b74c1a04954b78b4b6035e97a5e078a5a0f28ec96d547bfee9ace803ac0ac02c0255ab27520cfd7ef4b9c09cfe95a1ffa7e0b1d1ed8e22f2b2424d04f5009539de2a08d0471ac00")
        try psbt.signInput(with: key, at: 0)
        try psbt.finalizeAllInputs()
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "02000000000101bb49a80aabf0c7a8176eb7f573e19d727f305ef5f16ecb5997deac876d30c69300000000000a000000019041060000000000225120c462d8481f603feafee8298b9611fdb3a66d783e301eee33b6a75423ef6a9f85034081920e98e2d963eb2cfe642f11d98b25a197669f1abb9eafef27464a33ca4668f8e7e9eadaaef1480fcd29d9ae34150cf76c9e09a6763a236e521945ec8158d7255ab27520cfd7ef4b9c09cfe95a1ffa7e0b1d1ed8e22f2b2424d04f5009539de2a08d0471ac61c14008cb657acd7c2492a41c7b12ea5394e92ed8675ad0988079afa5b03fa314881a529c9fb3cd7e776d61b6225b6c610e8906fb8faa6c59ac5c3e95b5f82d29d61a529c9fb3cd7e776d61b6225b6c610e8906fb8faa6c59ac5c3e95b5f82d29d600000000")
    }

    func test_taproot_script_path_OP_CHECKSIG_3of3() throws {
        let keys = [
            "f00581828e1401d9d9b9b32e3d6205a8983f7bf6e53c5b4ec5edf15985a060f6",
            "2b4b46948bc1c60a90a9d5a5ecf65963af0741bb9c6cea0853db14002af850a1",
            "27bbb29e5d9dd88ca960cd86bbfd381e00016b71e2a5f73304ad01506164ca1b",
        ].map { PrivateKey(data: Data(hex: $0)) }

        let psbt = try Psbt.deserialize("70736274ff01005e020000000198c26c71e8cf507f15d25f0c0e2724ad883e49eafaf65dddecfabc2c159f55490000000000ffffffff019041060000000000225120bdf1d925163930fabbc98608304ae3c1c31d77d5054d6a23028ba712b30893bf000000000001012ba068060000000000225120bdf1d925163930fabbc98608304ae3c1c31d77d5054d6a23028ba712b30893bf6215c192b2f5ed9fe57443d68e4beab2a4c761468c3871ba1d7b01602a8828cd331e091a529c9fb3cd7e776d61b6225b6c610e8906fb8faa6c59ac5c3e95b5f82d29d61a529c9fb3cd7e776d61b6225b6c610e8906fb8faa6c59ac5c3e95b5f82d29d6692043569e9fa370e738435f66519d02a93053c0392eed984ba7a9da0665ff33cfd6ac20a0749611ee61110848e0851a810e989a8270ae6385ce2abb8edd04011d27662eba201d39e4e7920d9dcd3b02bf85c8683fa8ca3145e6fc1c8371d5bf06ae1e99b25cba539cc00000")
        try psbt.signInput(with: keys[1], at: 0)
        try psbt.signInput(with: keys[2], at: 0)
        try psbt.signInput(with: keys[0], at: 0)
        try psbt.finalizeAllInputs()
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "0200000000010198c26c71e8cf507f15d25f0c0e2724ad883e49eafaf65dddecfabc2c159f55490000000000ffffffff019041060000000000225120bdf1d925163930fabbc98608304ae3c1c31d77d5054d6a23028ba712b30893bf05406b98e41a00ba1f5cc9a98e7605b73458faa0ba3027974e47850e759e42cae3ba92dccf9a66e3a4ef9f885cb970aa306210de3d2c795ff2cbfb6b19158f3882b6404489191deb2862326efee922b5087cf16bfd44629f885078284623ca1033ed49416f23aa640354ded2755441fbc28ea5923e73b422577d773d0debe3e46657d8409b83a134c2183dcd69a025568e14873585e9b528663b1fa9b04c25dac4ec330aea4a8eec56ffc22e5ba69ae436a0a5c9a0dc0f025f00870318fd84113699093e682043569e9fa370e738435f66519d02a93053c0392eed984ba7a9da0665ff33cfd6ac20a0749611ee61110848e0851a810e989a8270ae6385ce2abb8edd04011d27662eba201d39e4e7920d9dcd3b02bf85c8683fa8ca3145e6fc1c8371d5bf06ae1e99b25cba539c61c192b2f5ed9fe57443d68e4beab2a4c761468c3871ba1d7b01602a8828cd331e091a529c9fb3cd7e776d61b6225b6c610e8906fb8faa6c59ac5c3e95b5f82d29d61a529c9fb3cd7e776d61b6225b6c610e8906fb8faa6c59ac5c3e95b5f82d29d600000000")
    }
}
