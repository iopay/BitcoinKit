//
//  TaprootTests.swift
//  
//
//  Created by liugang zhang on 2024/5/9.
//

import XCTest
@testable import BitcoinKit

class TaprootTests: XCTestCase {
    func testTaprootKeypath() throws {
        let pk0 = PrivateKey(data: Data(hex: "8dc789be1980af50d795c2a0dd2d12146d566331647f06c2071132b769386468"))
        let pk1 = PrivateKey(data: Data(hex: "4b411ea54a715c78e01eed8e3fca3345ee1328fb09e4d7d077b0f814bbaf1779"))

        print(pk0.toWIF())
        print(pk1.toWIF())

        let psbt = try Psbt.deserialize("70736274ff0100870200000002df7bba486867a96b4b2b029cc75d7594acb8b8b1c1f434e7cd63919b07c7721e0000000000ffffffffefbaef221bf1d5531f4ccd6cdf7c4f66cc7fa9e0743b674c7103f3aa914772810000000000ffffffff019041060000000000225120a3205ba404248e358829ba837b9585d137bc9bdd415b482fa3864f0d33936597000000000001012ba068060000000000225120d8f0d2a91beac3004bd6c02aaf9b86ac2e6b02e31e4c96b7f1248de5b582854401172062fe5466a62c8f401dc77d22daabcaa920598f8a74ed2405f03c7cd57dae001b000100bf0200000001f3693486ed31f55bc9fb429193df9355e3decc99e2a7c4eed295dd46d7b544fe010000006a473044022068fc69dab0a492474dbe00e0f4d7f79e839960902bf2304173eee09d7c822d3202202f45f589fff90c0b547d54c477fcd1bdb2fc5f5b82201db256fcb9a3a0fe2a540121027150b85099c24925c0b677fe1175817b8de40c0925f4d5cb746ca3331b30d2feffffffff01a0680600000000001976a9146ba0e1df98b4ba6ee77cf9317ff980ec4d3639e588ac000000000001052064b3e361fd97b5564eda2993dd271265fd1eaa5ffe0c5c3b072fb9782a889a7000")
        XCTAssertEqual(psbt.tx.inputs[0].previousOutput.hash.hex, "df7bba486867a96b4b2b029cc75d7594acb8b8b1c1f434e7cd63919b07c7721e")
        XCTAssertEqual(psbt.inputs[0].witnessUtxo?.lockingScript.hex, "5120d8f0d2a91beac3004bd6c02aaf9b86ac2e6b02e31e4c96b7f1248de5b5828544")
        XCTAssertEqual(psbt.inputs[0].witnessUtxo?.value, 420000)
        XCTAssertEqual(psbt.inputs[0].tapInternalKey?.hex, "62fe5466a62c8f401dc77d22daabcaa920598f8a74ed2405f03c7cd57dae001b")
        XCTAssertEqual(psbt.tx.inputs[1].previousOutput.hash.hex, "efbaef221bf1d5531f4ccd6cdf7c4f66cc7fa9e0743b674c7103f3aa91477281")
        XCTAssertEqual(psbt.tx.outputs[0].value, 410000)
        XCTAssertEqual(psbt.tx.outputs[0].lockingScript.hex, "5120a3205ba404248e358829ba837b9585d137bc9bdd415b482fa3864f0d33936597")
        XCTAssertEqual(psbt.outputs[0].tapInternalKey?.hex, "64b3e361fd97b5564eda2993dd271265fd1eaa5ffe0c5c3b072fb9782a889a70")

        try psbt.signInput(with: pk0.tweaked, at: 0)
        try psbt.signInput(with: pk1, at: 1)

        XCTAssertEqual(psbt.inputs[0].tapKeySig?.hex, "7f57dbcd71fcf8d1aa8e82f16d2096b9e90b86789f53931b82d3258d34f342d566fe06ee545a2bca690d7cd215c8cf4fa49ef878052e73f763eac4b98aa5d3a5")
        XCTAssertEqual(psbt.inputs[1].partialSig?.count, 1)
        XCTAssertEqual(psbt.inputs[1].partialSig?.first?.pubkey.hex, "0261f2ba743ba648041ca2bfaed36eedd86e7216104204d75ac8595241c81590c7")
        XCTAssertEqual(psbt.inputs[1].partialSig?.first?.signature.hex, "3044022024312bb863065f11df385deea3e099b68ed328bc480c6afc9c89da506ee06e4d02204aa421018fc578847c63079e8596f58091b17ac1550c28af42d6b8d51016bc2201")

        try psbt.finalizeAllInputs()

        XCTAssertEqual(psbt.serialized().hex, "70736274ff0100870200000002df7bba486867a96b4b2b029cc75d7594acb8b8b1c1f434e7cd63919b07c7721e0000000000ffffffffefbaef221bf1d5531f4ccd6cdf7c4f66cc7fa9e0743b674c7103f3aa914772810000000000ffffffff019041060000000000225120a3205ba404248e358829ba837b9585d137bc9bdd415b482fa3864f0d33936597000000000001012ba068060000000000225120d8f0d2a91beac3004bd6c02aaf9b86ac2e6b02e31e4c96b7f1248de5b582854401084201407f57dbcd71fcf8d1aa8e82f16d2096b9e90b86789f53931b82d3258d34f342d566fe06ee545a2bca690d7cd215c8cf4fa49ef878052e73f763eac4b98aa5d3a5000100bf0200000001f3693486ed31f55bc9fb429193df9355e3decc99e2a7c4eed295dd46d7b544fe010000006a473044022068fc69dab0a492474dbe00e0f4d7f79e839960902bf2304173eee09d7c822d3202202f45f589fff90c0b547d54c477fcd1bdb2fc5f5b82201db256fcb9a3a0fe2a540121027150b85099c24925c0b677fe1175817b8de40c0925f4d5cb746ca3331b30d2feffffffff01a0680600000000001976a9146ba0e1df98b4ba6ee77cf9317ff980ec4d3639e588ac0000000001076a473044022024312bb863065f11df385deea3e099b68ed328bc480c6afc9c89da506ee06e4d02204aa421018fc578847c63079e8596f58091b17ac1550c28af42d6b8d51016bc2201210261f2ba743ba648041ca2bfaed36eedd86e7216104204d75ac8595241c81590c70001052064b3e361fd97b5564eda2993dd271265fd1eaa5ffe0c5c3b072fb9782a889a7000")
        XCTAssertEqual(psbt.extractTransaction().serialized().hex, "02000000000102df7bba486867a96b4b2b029cc75d7594acb8b8b1c1f434e7cd63919b07c7721e0000000000ffffffffefbaef221bf1d5531f4ccd6cdf7c4f66cc7fa9e0743b674c7103f3aa91477281000000006a473044022024312bb863065f11df385deea3e099b68ed328bc480c6afc9c89da506ee06e4d02204aa421018fc578847c63079e8596f58091b17ac1550c28af42d6b8d51016bc2201210261f2ba743ba648041ca2bfaed36eedd86e7216104204d75ac8595241c81590c7ffffffff019041060000000000225120a3205ba404248e358829ba837b9585d137bc9bdd415b482fa3864f0d3393659701407f57dbcd71fcf8d1aa8e82f16d2096b9e90b86789f53931b82d3258d34f342d566fe06ee545a2bca690d7cd215c8cf4fa49ef878052e73f763eac4b98aa5d3a50000000000")
    }
}
